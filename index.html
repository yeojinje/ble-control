<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>BLE ì œì–´ ì¸í„°í˜ì´ìŠ¤</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ì•„ì´ì½˜ìš© Font Awesome ì¶”ê°€ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }

    .on {
      background-color: #4CAF50;
      color: white;
    }

    .off {
      background-color: #f44336;
      color: white;
    }

    i {
      margin-right: 8px;
    }

    #log {
      margin-top: 10px;
      white-space: pre-wrap;
      background: #f4f4f4;
      padding: 10px;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h2>ğŸ“¡ BLE ì¥ì¹˜ ì œì–´</h2>

  <!-- ê¸°ì¡´ ê¸°ëŠ¥ -->
  <button onclick="connect()">ğŸ”— BLE ì—°ê²°</button>
  <button onclick="send('>V1')">ì „ì•• ì½ê¸°</button>
  <button onclick="send('>T1')">ì˜¨ë„ ì½ê¸°</button>
  <button onclick="send('>B1')">ë²„ì € ON</button>
  <button onclick="send('>B0')">ë²„ì € OFF</button>
  <button onclick="send('>R1')">ë¦´ë ˆì´ ON</button>
  <button onclick="send('>R0')">ë¦´ë ˆì´ OFF</button>

  <hr style="margin: 20px 0;">

  <!-- ìƒˆë¡œ ì¶”ê°€ëœ MEL ì œì–´ ë²„íŠ¼ -->
  <button class="on" onclick="send('>M11')"><i class="fas fa-bell"></i> MEL1 ON</button>
  <button class="off" onclick="send('>M10')"><i class="fas fa-bell-slash"></i> MEL1 OFF</button>
  <button class="on" onclick="send('>M21')"><i class="fas fa-music"></i> MEL2 ON</button>
  <button class="off" onclick="send('>M20')"><i class="fas fa-volume-mute"></i> MEL2 OFF</button>

  <div id="log"></div>

  <script>
    let device, server, service, characteristic;

    async function connect() {
      try {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
        });

        server = await device.gatt.connect();
        service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');

        const characteristics = await service.getCharacteristics();
        for (const c of characteristics) {
          const props = c.properties;
          if (props.write || props.writeWithoutResponse) {
            characteristic = c;
            break;
          }
        }

        if (!characteristic) {
          log("âŒ ì“°ê¸° ê°€ëŠ¥í•œ characteristicì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        log("âœ… BLE ì—°ê²° ì„±ê³µ: " + device.name);
      } catch (e) {
        if (e.name === 'NotFoundError') {
          log("â„¹ï¸ BLE ì¥ì¹˜ ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          log("âŒ ì—°ê²° ì‹¤íŒ¨: " + e);
        }
      }
    }

    async function send(cmd) {
      if (!characteristic || !device || !device.gatt.connected) {
        log("â›” ë¨¼ì € BLEì— ì—°ê²°í•˜ì„¸ìš”.");
        return;
      }

      const encoder = new TextEncoder();
      try {
        await characteristic.writeValue(encoder.encode(cmd + '\n'));
        log("ğŸ“¤ ì „ì†¡ ì„±ê³µ: " + cmd);
      } catch (err) {
        log("âŒ ì „ì†¡ ì‹¤íŒ¨: " + err);
      }
    }

    function log(msg) {
      const logEl = document.getElementById('log');
      logEl.textContent += msg + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    // PWAìš© Service Worker ë“±ë¡
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("âœ… Service Worker ë“±ë¡ë¨"))
        .catch(err => console.error("âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:", err));
    }
  </script>
</body>
</html>
